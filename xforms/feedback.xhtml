<?xml version="1.0" encoding="utf-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema"
	xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
	xmlns:xi="http://www.w3.org/2001/XInclude">
	<head>
		<title>Numishare: Feedback</title>
		<link rel="stylesheet" href="/fr/style/bootstrap/css/bootstrap.css" type="text/css" />
		<link rel="stylesheet" href="/fr/style/form-runner-bootstrap-override.css" type="text/css" />

		<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" />
		<script type="text/javascript" src="https://netdna.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
		<link rel="shortcut icon" href="/ops/images/orbeon-icon-16.ico" />
		<link rel="icon" href="/ops/images/orbeon-icon-16.png" type="image/png" />
		<link rel="stylesheet" href="/apps/numishare/xforms/css/xforms.css" />
		<link rel="stylesheet" href="/apps/numishare/ui/css/style.css" />

		<!-- model -->
		<xforms:model xxforms:function-library="org.orbeon.oxf.fr.library.FormRunnerFunctionLibrary">
			<xforms:instance id="control-instance" xxforms:exclude-result-prefixes="#all">
				<controls xmlns="">
					<status></status>
					<collection-name></collection-name>
					<verified>false</verified>
					<send-trigger>false</send-trigger>
				</controls>
			</xforms:instance>

			<xforms:instance id="feedback" xxforms:exclude-result-prefixes="#all">
				<feedback xmlns="">
					<name></name>
					<email></email>
					<text></text>
				</feedback>
			</xforms:instance>

			<xforms:instance id="config" xxforms:exclude-result-prefixes="#all">
				<config xmlns=""></config>
			</xforms:instance>

			<xforms:instance id="email-config" xxforms:exclude-result-prefixes="#all">
				<message xmlns="">
					<smtp-host/>
					<from>
						<email></email>
						<name></name>
					</from>
					<subject></subject>
					<body content-type="text/plain"></body>
				</message>
			</xforms:instance>

			<!-- null element for call-xpl -->
			<xforms:instance id="dump">
				<dump xmlns=""></dump>
			</xforms:instance>

			<!-- ************* BINDINGS **********************-->
			<xforms:bind nodeset="instance('control-instance')">
				<xforms:bind nodeset="verified" type="xs:boolean"/>				
				<!-- enable/disable the send email trigger based on validation of the form -->
				<xforms:bind id="send-trigger" nodeset="send-trigger" type="xs:boolean" readonly=". != true()"/>
			</xforms:bind>
			
			<xforms:bind nodeset="instance('email-config')">
				<xforms:bind nodeset="from|to">
					<xforms:bind nodeset="name" required="true()"/>
					<xforms:bind nodeset="email" required="true()" type="xforms:email"/>
				</xforms:bind>
				<xforms:bind nodeset="body" required="true()"/>
			</xforms:bind>
			

			<!-- **************** DYNAMIC VALIDATION CONTROLS ********************** -->
			<xforms:action ev:event="xxforms-invalid" ev:observer="email-config">
				<xforms:setvalue ref="instance('control-instance')/send-trigger" value="false()"/>
			</xforms:action>
			
			<xforms:action ev:event="xxforms-valid" ev:observer="email-config">
				<xforms:setvalue ref="instance('control-instance')/send-trigger" value="true()"/>
			</xforms:action>

			<!-- **************** MODEL-CONSTRUCT-DONE ********************** -->
			<xforms:action ev:event="xforms-model-construct-done">
				<!-- load the config -->
				<xforms:insert context="instance('dump')"
					origin="xxforms:call-xpl('oxf:/apps/numishare/xpl/models/config.xpl', 'data', instance('dump'), 'data')"/>
				<xforms:insert context="instance('config')" origin="instance('dump')/config/*"/>
				
				<!-- set email processor configuration from the config -->
				<xforms:insert context="instance('email-config')" nodeset="from" position="after" origin="instance('config')/pages/feedback/to"/>
				<xforms:setvalue ref="instance('email-config')/smtp-host" value="instance('config')/pages/feedback/smtp-host"/>
				<xforms:setvalue ref="instance('email-config')/subject" value="concat('Feedback from ', instance('config')/title)"/>
			</xforms:action>
		</xforms:model>
	</head>

	<body>
		<xforms:var name="display_path">../</xforms:var>
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-12">
					<h1>Feedback</h1>
					
					<xforms:switch>
						<xforms:case id="feedback-form">
							<xforms:group ref="instance('email-config')">
								<div>
									
									<p>Instructions here.</p>
									<div>
										<xforms:input ref="from/name">
											<xforms:label>Name</xforms:label>
											<xforms:alert>Required</xforms:alert>
										</xforms:input>
									</div>
									<div>
										<xforms:input ref="from/email">
											<xforms:label>Email Address</xforms:label>
											<xforms:alert>Must conform to a valid email address</xforms:alert>
										</xforms:input>
									</div>
									<div>
										<xforms:textarea ref="body">
											<xforms:label>Feedback</xforms:label>
											<xforms:alert>Required</xforms:alert>
										</xforms:textarea>
									</div>
								</div>
							</xforms:group>
							
							<div>
								<xforms:trigger bind="send-trigger">
									<xforms:label>Send</xforms:label>
									<xforms:action ev:event="DOMActivate">
										<!-- determine whether or not the recaptcha has been checked -->
										<xforms:dispatch target="my-recaptcha" name="fr-verify"/>
										
										<!-- send email if verified -->
										<xforms:action if="instance('control-instance')/verified = true()">
											<xforms:toggle case="response-success"/>
											<xforms:insert context="instance('dump')"
												origin="xxforms:call-xpl('oxf:/apps/numishare/xpl/controllers/feedback-email.xpl', 'data', instance('email-config'), 'data')"
											/>											
										</xforms:action>								
									</xforms:action>							
								</xforms:trigger>
							</div>
							
							<fr:recaptcha id="my-recaptcha">
								<xforms:action ev:event="fr-verify-done">
									<xforms:setvalue ref="instance('control-instance')/verified" value="true()"/>
								</xforms:action>
								<xforms:action ev:event="fr-verify-error">
									<xforms:setvalue ref="instance('control-instance')/verified" value="false()"/>
								</xforms:action>
							</fr:recaptcha>
							
						</xforms:case>
						<xforms:case id="response-success">
							<p>The email has been sent to the managers of this collection. Thank you for your feedback.</p>
						</xforms:case>
					</xforms:switch>

					
					<fr:xforms-inspector/>
				</div>
			</div>
		</div>
	</body>
</html>
